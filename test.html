<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Responsive Rotating Chart</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body, html { margin:0; padding:0; width:100%; height:100%; font-family: Arial; }
    svg { width:100vw; height:100vh; }
    .bar { fill: steelblue; fill-opacity:0.8; }
    .bar:hover { fill-opacity:1; }
    .line { fill:none; stroke:orange; stroke-width:3px; }
    .dot { fill:orange; }
  </style>
</head>
<body>
<svg></svg>

<script>
const svg = d3.select("svg");
let margin = {top:60, right:60, bottom:60, left:80};
let width = window.innerWidth - margin.left - margin.right;
let height = window.innerHeight - margin.top - margin.bottom;

const chart = svg.append("g")
  .attr("transform", `translate(${margin.left},${margin.top})`);

const csvFile = "data.csv";

function drawChart() {
  // Clear previous chart
  chart.selectAll("*").remove();
  width = window.innerWidth - margin.left - margin.right;
  height = window.innerHeight - margin.top - margin.bottom;

  d3.csv(csvFile, d => ({
    Minute: d["Minute"].trim(),
    Power: +d["Power"].trim(),
    Nominal: +d["Nominal"].trim()
  })).then(rawData => {

    const grouped = d3.groups(rawData, d => d.Minute);
    const data = grouped.map(([minute, rows]) => ({
      Minute: minute,
      Power: d3.mean(rows, r => r.Power),
      Nominal: +rows[0].Nominal
    }));

    // Function to detect if the user is on a mobile device
    function isMobileDevice() {
        return !!/Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent);
    }

    let x, y, xAxis, yAxis;

    if (!isMobileDevice()) {
      // Desktop horizontal chart
      x = d3.scaleBand().domain(data.map(d => d.Minute)).range([0,width]).padding(0.2);
      y = d3.scaleLinear().domain([0,d3.max(data,d=>Math.max(d.Power,d.Nominal))*1.1]).nice().range([height,0]);

      xAxis = g => g.attr("transform",`translate(0,${height})`).call(d3.axisBottom(x));
      yAxis = g => g.call(d3.axisLeft(y));

      // Bars
      chart.selectAll(".bar")
        .data(data)
        .join("rect")
          .attr("class","bar")
          .attr("x",d=>x(d.Minute))
          .attr("y",d=>y(d.Power))
          .attr("width",x.bandwidth())
          .attr("height",d=>height - y(d.Power));

      // Line
      const line = d3.line()
        .x(d=>x(d.Minute)+x.bandwidth()/2)
        .y(d=>y(d.Nominal))
        .curve(d3.curveMonotoneX);

      chart.append("path").datum(data).attr("class","line").attr("d",line);

      // Dots
      chart.selectAll(".dot")
        .data(data)
        .join("circle")
          .attr("class","dot")
          .attr("cx",d=>x(d.Minute)+x.bandwidth()/2)
          .attr("cy",d=>y(d.Nominal))
          .attr("r",5);

    } else {
      // Mobile vertical chart (rotated 90Â°)
      y = d3.scaleBand().domain(data.map(d=>d.Minute)).range([0,height]).padding(0.2);
      x = d3.scaleLinear().domain([0,d3.max(data,d=>Math.max(d.Power,d.Nominal))*1.1]).nice().range([0,width]);

      xAxis = g => g.attr("transform",`translate(0,${height})`).call(d3.axisBottom(x));
      yAxis = g => g.call(d3.axisLeft(y))
                   .selectAll("text")
                   .attr("transform","rotate(-45)")
                   .style("text-anchor","end");

      // Bars horizontal
      chart.selectAll(".bar")
        .data(data)
        .join("rect")
          .attr("class","bar")
          .attr("y",d=>y(d.Minute))
          .attr("x",0)
          .attr("height",y.bandwidth())
          .attr("width",d=>x(d.Power));

      // Line horizontal
      const line = d3.line()
        .x(d=>x(d.Nominal))
        .y(d=>y(d.Minute)+y.bandwidth()/2)
        .curve(d3.curveMonotoneY);

      chart.append("path").datum(data).attr("class","line").attr("d",line);

      // Dots
      chart.selectAll(".dot")
        .data(data)
        .join("circle")
          .attr("class","dot")
          .attr("cx",d=>x(d.Nominal))
          .attr("cy",d=>y(d.Minute)+y.bandwidth()/2)
          .attr("r",5);
    }

    chart.append("g").call(xAxis);
    chart.append("g").call(yAxis);

  }).catch(error => console.error("CSV error:",error));
}

// Initial draw
drawChart();

// Redraw on resize
window.addEventListener("resize", drawChart);
</script>

</body>
</html>
